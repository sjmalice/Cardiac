import pandas as pd

def generateEnrollId(df, columns = ['patient_link', 'enrollment_date']):
    '''
    Takes patient enrollment records and generates new enrollId and count
    feature for each time the patient is enrolled
    Mutating function
    Keyword Arguments
    -----------------
    df -- patient_enrollment_records as pandas df
    columns -- patient_link and enrollment_date columns as list. Only needed if
    column names have not had case lowered.
    '''
    # group by patient_link and Enrollment_Date in patient_enrollment_records
    # sheet to generate enroll_id for each cycle of patient through facility
    newKey = pd.DataFrame([key for key, _ in df.groupby(columns)],
    columns=columns)
    # add visit number feature
    visitNo = [1]
    for i in range(1, len(newKey)):
        if newKey.patient_link[i] == newKey.patient_link[i-1]:
            visitNo.append(visitNo[-1]+1)
        else:
            visitNo.append(1)
    newKey['visitNo'] = visitNo
    #add new enrollId feature that's unique for each new visit
    newKey['enrollId'] =\
    newKey.patient_link.map(str) + '_' + newKey.visitNo.map(str)
    return(newKey)

def addEnrollId(df, date_col, rootDf):
    '''
    Adds new enrollId column to any data frame, df, containing a 'patient_link'
    and date column, date_col, using enrollId data frame generated by
    "generateEnrollId" function.
    Mutating Function
    Keyword Arguments
    -----------------
    df -- The date frame that new enrollId is added to.
    date_col -- the column of data frame df as string that contains the date to
    compare to date in rootDf.
    rootDf -- A data frame assumed to be generated by the "generateEnrollId"
    function.
    '''
    #add new enrollID column
    df['enrollId'] = pd.Series(index = df.index)
    # add enrollID for each row in rootDf when patient_link match and date is
    # greater than enrollment_date. Earlier enrollment_date are checked first
    # and overwritten when later dates are checked after
    unmatchedPatients = []
    for i in rootDf.index:
        print("df[date_col] type: \n")
        print(df[date_col][1])
        print(type(df[date_col][1]))
        print("rootDf.enrollment_date[i] type: \n")
        print(rootDf.enrollment_date[i])
        print(type(rootDf.enrollment_date[i]))
        # find patient links and dates that match new enroll ids
        mask = (df.patient_link == rootDf.patient_link[i]) &\
        (df[date_col] - rootDf.enrollment_date[i] >= -pd.Timedelta("13 days"))

        unmatchedPatients.append(~mask.any())
        df.loc[mask, "enrollId"] = rootDf.enrollId[i]
    # print message if any enroll Ids were unmatched
    if not any(unmatchedPatients):
        print("No records found in the data frame that match these enroll IDs:")
        print("="*40)
        print(rootDf.enrollId[unmatchedPatients])
    else:
        print("Records for all patients found in the data frame. Yay!\n")
    #print message if any rows in df are not assigned an enrollId
    unmatchedRows = df.enrollId.isna()
    if ~unmatchedRows.any():
        print("All rows in data frame matched succesfully. Yay!\n")
    else:
        print("Failed to add enrollID to {} rows with indexes:"\
        .format(unmatchedRows.sum()))
        print("="*40)
        print(df.index[unmatchedRows])
    return(df)
